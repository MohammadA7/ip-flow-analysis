## Project Overview

The Project aim is to analyze IP network traffic flows to predict application layer protocol (specific application) such as Facebook, YouTube, and Instagram.

The dataset can be found [here](https://www.kaggle.com/jsrojas/ip-network-traffic-flows-labeled-with-87-apps), the dataset contains 87 features. Each instance holds the information of an IP flow generated by a network device i.e., source and destination IP addresses, ports, interarrival times, layer 7 protocol (application) used on the flow that we want to predict class.

## Problem Statement

The number of cyber threats is growing constantly. They have become more sophisticated, precisely targeted and they can overcome traditional security solutions for data network perimeter. 
Analyzing IP flows is an essential part of traffic measurement for cybersecurity, as IP flows gather information only from packet headers.

## Motivation

Considering that most of the network traffic classification datasets are aimed only at identifying the type of application an IP flow holds (WWW, DNS, FTP, P2P, Telnet,etc), this dataset goes a step further by generating machine learning models capable of detecting specific applications such as Facebook, YouTube, Instagram, etc, from IP flow statistics (currently 75 applications).

## Metrics

We will use accuracy as a metric for multiclass classification, it calculates how often predictions classes match labels.

## Exploratory Analysis

The dataset contains 3577296 rows and 87 columns

**Dataset preview**

| Flow.ID                             | Source.IP   | Source.Port | Destination.IP | Destination.Port | Protocol | Timestamp          | Flow.Duration | Total.Fwd.Packets | Total.Backward.Packets | Total.Length.of.Fwd.Packets | Total.Length.of.Bwd.Packets | Fwd.Packet.Length.Max | Fwd.Packet.Length.Min | Fwd.Packet.Length.Mean | Fwd.Packet.Length.Std | Bwd.Packet.Length.Max | Bwd.Packet.Length.Min | Bwd.Packet.Length.Mean | Bwd.Packet.Length.Std | Flow.Bytes.s | Flow.Packets.s | Flow.IAT.Mean | Flow.IAT.Std | Flow.IAT.Max | Flow.IAT.Min | Fwd.IAT.Total | Fwd.IAT.Mean | Fwd.IAT.Std | Fwd.IAT.Max | Fwd.IAT.Min | Bwd.IAT.Total | Bwd.IAT.Mean | Bwd.IAT.Std | Bwd.IAT.Max | Bwd.IAT.Min | Fwd.PSH.Flags | Bwd.PSH.Flags | Fwd.URG.Flags | Bwd.URG.Flags | Fwd.Header.Length | Bwd.Header.Length | Fwd.Packets.s | Bwd.Packets.s | Min.Packet.Length | Max.Packet.Length | Packet.Length.Mean | Packet.Length.Std | Packet.Length.Variance | FIN.Flag.Count | SYN.Flag.Count | RST.Flag.Count | PSH.Flag.Count | ACK.Flag.Count | URG.Flag.Count | CWE.Flag.Count | ECE.Flag.Count | Down.Up.Ratio | Average.Packet.Size | Avg.Fwd.Segment.Size | Avg.Bwd.Segment.Size | Fwd.Header.Length.1 | Fwd.Avg.Bytes.Bulk | Fwd.Avg.Packets.Bulk | Fwd.Avg.Bulk.Rate | Bwd.Avg.Bytes.Bulk | Bwd.Avg.Packets.Bulk | Bwd.Avg.Bulk.Rate | Subflow.Fwd.Packets | Subflow.Fwd.Bytes | Subflow.Bwd.Packets | Subflow.Bwd.Bytes | Init_Win_bytes_forward | Init_Win_bytes_backward | act_data_pkt_fwd | min_seg_size_forward | Active.Mean | Active.Std | Active.Max | Active.Min | Idle.Mean | Idle.Std | Idle.Max | Idle.Min | Label  | L7Protocol | ProtocolName |
|-------------------------------------|-------------|-------------|----------------|------------------|----------|--------------------|---------------|-------------------|------------------------|-----------------------------|-----------------------------|-----------------------|-----------------------|------------------------|-----------------------|-----------------------|-----------------------|------------------------|-----------------------|--------------|----------------|---------------|--------------|--------------|--------------|---------------|--------------|-------------|-------------|-------------|---------------|--------------|-------------|-------------|-------------|---------------|---------------|---------------|---------------|-------------------|-------------------|---------------|---------------|-------------------|-------------------|--------------------|-------------------|------------------------|----------------|----------------|----------------|----------------|----------------|----------------|----------------|----------------|---------------|---------------------|----------------------|----------------------|---------------------|--------------------|----------------------|-------------------|--------------------|----------------------|-------------------|---------------------|-------------------|---------------------|-------------------|------------------------|-------------------------|------------------|----------------------|-------------|------------|------------|------------|-----------|----------|----------|----------|--------|------------|--------------|
| 172.19.1.46-10.200.7.7-52422-3128-6 | 172.19.1.46 | 52422       | 10.200.7.7     | 3128             | 6        | 26/04/201711:11:17 | 45523         | 22                | 55                     | 132                         | 110414.0                    | 6                     | 6                     | 6.000000               | 0.000000              | 4380                  | 1187                  | 2007.527273            | 768.481689            | 2.428355e+06 | 1.691453e+03   | 598.986842    | 816.061346   | 3880.0       | 1            | 45523.0       | 2167.761905  | 1319.384512 | 5988.0      | 698.0       | 41178.0       | 762.555556   | 1230.348220 | 5133.0      | 1.0         | 0             | 0             | 0             | 0             | 440               | 1100              | 4.832722e+02  | 1208.180480   | 6                 | 4380              | 1417.333333        | 1121.579194       | 1.257940e+06           | 0              | 0              | 0              | 0              | 1              | 0              | 0              | 0              | 2             | 1435.74026          | 6.000000             | 2007.527273          | 440                 | 0                  | 0                    | 0                 | 0                  | 0                    | 0                 | 22                  | 132               | 55                  | 110414            | 256                    | 490                     | 21               | 20                   | 0.0         | 0.0        | 0.0        | 0.0        | 0.0  Data Preprocessing     | 0.0      | 0.0      | 0.0      | BENIGN | 131        | HTTP_PROXY   |

Number of null values in the dataset is 0

![number of flows per connection](https://raw.githubusercontent.com/MohammadA7/ip-flow-analysis/master/docs/number-of-flows-per-connection.png)


We can see that there are some connection with a high number of flows 

The figure below will show the top 10 applications in the dataset

![top-10-applications](https://raw.githubusercontent.com/MohammadA7/ip-flow-analysis/master/docs/top-10-applications.png)

## Data Preprocessing

We will not aggregation flows by connection (maybe in future improvements) will deal with each flow alone

Columns to drop - the reason to drop
* **Flow.ID** - It's just a connection identifier
* **Source.IP** - It's just a connection identifier
* **Source.Port** - Ports can be useful to identify protocols but because of dynamic ports opening in client-side it can be maybe misleading (maybe in future improvements)
* **Destination.IP** It's just a connection identifier
* **Destination.Port** - Ports can be useful to identify protocols but because of dynamic ports opening in client-side it can be maybe misleading (maybe in future improvements)
* **Timestamp** - It will not be useful in identifying individual flows
* **Label** - It contains only one value

The data will be split into X and Y
X values will be everything except ProtocolName and L7Protocol
Y values will be dummy variables extracted from ProtocolName

then we will split the data into train test split with the test will be 0.25 of the data

finally we will apply [StandardScaler](https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html) on the data
```
scale = StandardScaler()
# Standardize features by removing the mean and scaling to unit variance
X_train = scale.fit_transform(X_train)
X_test = scale.transform(X_test)
```

## Data Modeling

We will use Deep learning model, the reason for that is it gives better accuracy, the problem with most machine learning algorithms it doesn't support batch processing and consume a lot of time, I have experienced a lot of MemoryError and Process being killed with 32GB RAM, also machine learning models need better domain expert.

I have tried **OneVsRestClassifier(LinearSVC())** and the accurcy was 45

The final model properties
* Input layer with 78 dimensions (number of features)
* 3 hidden layers with relu activation
* dropout 25% between every layer
* categorical cross-entropy as loos function
* Stochastic gradient descent as an optimizer with 0.01 learning rate, 0.5 momentum, and 1e-6 decay
* Accuracy as the metric
* Output layer 78 dimensions (number of classes)
```
model = Sequential()

model.add(Dense(512, activation='relu', input_dim=78))
model.add(Dropout(0.25))
model.add(Dense(256, activation='relu'))
model.add(Dropout(0.25))
model.add(Dense(128, activation='relu'))
model.add(Dropout(0.25))
model.add(Dense(78, activation='softmax'))

# Note that we use a “softmax” activation 
# function in the output layer. This is to ensure 
# the output values are in the range of 0 and 1 
# and the max will be the predicted class.

sgd = SGD(lr=0.01, decay=1e-6, momentum=0.5, nesterov=True)

model.compile(loss='categorical_crossentropy',
              optimizer=sgd,
              metrics=['accuracy'])
```

The training was with 30 epochs and 128 batch_size

## Results evaluation

The test loss is 1.0517627823662645
The test accuracy is 0.6631679346653662

Some classification samples

![Predection for HTTP_PROXY](https://raw.githubusercontent.com/MohammadA7/ip-flow-analysis/master/docs/prediction-for-HTTP_PROXY.png)
![Predection for SSL](https://raw.githubusercontent.com/MohammadA7/ip-flow-analysis/master/docs/prediction-for-SSL.png)

We can see in the above classification samples of our model, isn't that accurate all the time, the model needs some improvement.

Deep learning worked better maybe because it can identify deep patterns in the data that traditional machine learning couldn't identify 

## Conclusion

This concludes our analysis that we can identify IP flow application with 66% accuracy in multiclass classification with 78 class which is not that bad.

The dataset contains 3577296  record which is hard to train with algorithms that don't support batch processing.

### Future Improvement

We can improve the model by 
* using more features that we have dropped
* extract new features like (Is the flow for ingoing traffic or outgoing? Is the port is privileged or not?)
* aggregate flows by connection

## Acknowledgements

I would like to thank Juan Sebastián Rojas and Universidad Del Cauca for providing this dataset
